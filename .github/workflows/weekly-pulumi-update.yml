name: weekly-pulumi-update
# on:
#   schedule:
#   - cron: 35 12 * * 4
#   workflow_dispatch: {}
on:
  pull_request:
    branches:
      - master

permissions:
  pull-requests: write
# env:
#   GITHUB_TOKEN: ${{ secrets.PULUMI_BOT_TOKEN }}
jobs:
  weekly-pulumi-update:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        goversion:
        - 1.21.x
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3
    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{matrix.goversion}}
        cache-dependency-path: |
            **/go.sum
    - name: Update Pulumi/Pulumi
      id: gomod
      run: |
        git config --local user.email 'bot@pulumi.com'
        git config --local user.name 'pulumi-bot'

        PULUMI_VERSION=$(./scripts/get-latest-pulumi-version.sh)
        echo "Latest Pulumi version is $PULUMI_VERSION"
        echo "PULUMI_VERSION=$PULUMI_VERSION" >> "$GITHUB_ENV"

        git checkout -b update-pulumi/$PULUMI_VERSION-${{ github.run_id }}-${{ github.run_number }}

        echo "Update Pulumi dependencies to $PULUMI_VERSION"
        ./scripts/bump-pulumi-deps.sh --version "$PULUMI_VERSION"

        git update-index -q --refresh

        if ! git diff-files --quiet; then
          echo changes=1 >> "$GITHUB_OUTPUT"
        fi
    - name: Commit changes
      if: steps.gomod.outputs.changes != 0
      run: |
        make build && make lint
        git add .

        git commit -m "Update pulumi/pulumi version to $PULUMI_VERSION"

        git push origin update-pulumi/$PULUMI_VERSION-${{ github.run_id }}-${{ github.run_number }}
    - name: pull-request
      run: |
        gh_pr_up() { gh pr create $* || gh pr edit $* }
        gh_pr_up --title "Update pulumi/pulumi version to $PULUMI_VERSION"
        Disable auto-merge for testing
        # gh pr merge --auto
    name: weekly-pulumi-update
